{"version":3,"sources":["transport/webusb.ts"],"names":[],"mappings":"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","file":"webusb.js","sourcesContent":["/*\n* DAPjs\n* Copyright Arm Limited 2018\n*\n* Permission is hereby granted, free of charge, to any person obtaining a copy\n* of this software and associated documentation files (the \"Software\"), to deal\n* in the Software without restriction, including without limitation the rights\n* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n* copies of the Software, and to permit persons to whom the Software is\n* furnished to do so, subject to the following conditions:\n*\n* The above copyright notice and this permission notice shall be included in all\n* copies or substantial portions of the Software.\n*\n* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n* SOFTWARE.\n*/\n\nimport { Transport } from \"./\";\n\n/**\n * @hidden\n */\nconst DEFAULT_CONFIGURATION = 1;\n/**\n * @hidden\n */\nconst DEFAULT_CLASS = 0xFF;\n\n/**\n * @hidden\n */\nconst GET_REPORT = 0x01;\n/**\n * @hidden\n */\nconst SET_REPORT = 0x09;\n/**\n * @hidden\n */\nconst OUT_REPORT = 0x200;\n/**\n * @hidden\n */\nconst IN_REPORT = 0x100;\n\n/**\n * WebUSB Transport class\n * https://wicg.github.io/webusb/\n */\nexport class WebUSB implements Transport {\n\n    private interfaceNumber?: number;\n    private endpointIn?: USBEndpoint;\n    private endpointOut?: USBEndpoint;\n    public readonly packetSize = 64;\n\n    /**\n     * WebUSB constructor\n     * @param device WebUSB device to use\n     * @param interfaceClass Optional interface class to use (default: 0xFF)\n     * @param configuration Optional Configuration to use (default: 1)\n     * @param alwaysControlTransfer Whether to always use control transfer instead of endpoints (default: false)\n     */\n    constructor(private device: USBDevice, private interfaceClass = DEFAULT_CLASS, private configuration = DEFAULT_CONFIGURATION, private alwaysControlTransfer: boolean = false) {\n    }\n\n    private extendBuffer(data: BufferSource, packetSize: number): BufferSource {\n        function isView(source: ArrayBuffer | ArrayBufferView): source is ArrayBufferView {\n            return (source as ArrayBufferView).buffer !== undefined;\n        }\n\n        const arrayBuffer = isView(data) ? data.buffer : data;\n        const length = Math.min(arrayBuffer.byteLength, packetSize);\n\n        const result = new Uint8Array(length);\n        result.set(new Uint8Array(arrayBuffer));\n\n        return result;\n    }\n\n    /**\n     * Open device\n     * @returns Promise\n     */\n    public open(): Promise<void> {\n        return this.device.open()\n        .then(() => this.device.selectConfiguration(this.configuration))\n        .then(() => {\n            const interfaces = this.device.configuration!.interfaces.filter(iface => {\n                return iface.alternates[0].interfaceClass === this.interfaceClass;\n            });\n\n            if (!interfaces.length) {\n                throw new Error(\"No valid interfaces found.\");\n            }\n\n            // Prefer interface with endpoints\n            let selectedInterface = interfaces.find(iface => iface.alternates[0].endpoints.length > 0);\n\n            // Otherwise use the first\n            if (!selectedInterface) {\n                selectedInterface = interfaces[0];\n            }\n\n            this.interfaceNumber = selectedInterface.interfaceNumber;\n\n            // If we always want to use control transfer, don't find/set endpoints and claim interface\n            if (!this.alwaysControlTransfer) {\n                const endpoints = selectedInterface.alternates[0].endpoints;\n\n                this.endpointIn = undefined;\n                this.endpointOut = undefined;\n\n                for (const endpoint of endpoints) {\n                    if (endpoint.direction === \"in\") this.endpointIn = endpoint;\n                    else this.endpointOut = endpoint;\n                }\n            }\n\n            return this.device.claimInterface(this.interfaceNumber);\n        });\n    }\n\n    /**\n     * Close device\n     * @returns Promise\n     */\n    public close(): Promise<void> {\n        return this.device.close();\n    }\n\n    /**\n     * Read from device\n     * @returns Promise of DataView\n     */\n    public read(): Promise<DataView> {\n        if (this.interfaceNumber === undefined) return Promise.reject(\"No device opened\");\n\n        // Use endpoint if it exists\n        if (this.endpointIn) {\n            return this.device.transferIn(\n                this.endpointIn.endpointNumber,\n                this.packetSize\n            )\n            .then(result => result.data!);\n        }\n\n        // Fallback to using control transfer\n        return this.device.controlTransferIn(\n            {\n                requestType: \"class\",\n                recipient: \"interface\",\n                request: GET_REPORT,\n                value: IN_REPORT,\n                index: this.interfaceNumber\n            },\n            this.packetSize\n        )\n        .then(result => result.data!);\n    }\n\n    /**\n     * Write to device\n     * @param data Data to write\n     * @returns Promise\n     */\n    public write(data: BufferSource): Promise<void> {\n        if (this.interfaceNumber === undefined) return Promise.reject(\"No device opened\");\n\n        const buffer = this.extendBuffer(data, this.packetSize);\n\n        // Use endpoint if it exists\n        if (this.endpointOut) {\n            return this.device.transferOut(\n                this.endpointOut.endpointNumber,\n                buffer\n            )\n            .then(() => undefined);\n        }\n\n        // Fallback to using control transfer\n        return this.device.controlTransferOut(\n            {\n                requestType: \"class\",\n                recipient: \"interface\",\n                request: SET_REPORT,\n                value: OUT_REPORT,\n                index: this.interfaceNumber\n            },\n            buffer\n        )\n        .then(() => undefined);\n    }\n}\n"],"sourceRoot":"../../src"}